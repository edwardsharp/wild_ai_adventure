<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebSocket Demo - Modular Components</title>
</head>
<body>
  <websocket-demo websocketUrl="ws://localhost:8080/ws" autoConnect="false" showDebugLog="true"></websocket-demo>

  <script type="module">
import{h as le,x as We,n as Y,j as S,m as Ne,k as xt,b as Ct,d as Bt,a as C,e as Oe,o as Pt,t as f,i as o,c as B,w as J,S as R,F as ve,f as te,g as $e,s as Ut,u as kt}from"./types-CptiQF1l.js";import{W as Lt,C as Ie}from"./websocket-client-BZNd2INk.js";class Dt extends EventTarget{blobs=[];blobDataCache=new Map;loadingBlobs=new Set;baseUrl;constructor(e="http://localhost:8080"){super(),this.baseUrl=e.replace(/\/$/,"")}updateBlobs(e){this.blobs=[...e],this.blobs.forEach(t=>{t.mime?.startsWith("image/")&&!t.local_path&&!this.isCached(t.id)&&!this.isLoading(t.id)&&setTimeout(()=>this.requestBlobData(t.id),100)}),this.dispatchEvent(new CustomEvent("blobs-updated",{detail:{blobs:this.blobs,count:this.blobs.length}}))}getBlobs(){return[...this.blobs]}getBlob(e){return this.blobs.find(t=>t.id===e)}cacheBlobData(e){if(!e.id||!e.data)return;const t=new Uint8Array(e.data),s=new Blob([t],{type:e.mime||"application/octet-stream"}),r=URL.createObjectURL(s);this.blobDataCache.set(e.id,r),this.loadingBlobs.delete(e.id),this.dispatchEvent(new CustomEvent("blob-data-cached",{detail:{id:e.id,dataUrl:r,mime:e.mime}}))}isCached(e){return this.blobDataCache.has(e)}getCachedDataUrl(e){return this.blobDataCache.get(e)}isLoading(e){return this.loadingBlobs.has(e)}markAsLoading(e){this.loadingBlobs.add(e)}requestBlobData(e){this.isCached(e)||this.isLoading(e)||(this.markAsLoading(e),this.dispatchEvent(new CustomEvent("blob-data-requested",{detail:{id:e}})))}getBlobDisplayInfo(e){const t=this.getStorageType(e),s=this.getFileUrl(e);return{id:e.id,mime:e.mime||"Unknown type",size:this.formatFileSize(e.size),sha256:e.sha256,clientId:e.source_client_id||"Unknown",path:e.local_path||"None",createdAt:new Date(e.created_at).toLocaleString(),metadata:Object.keys(e.metadata||{}).length>0?JSON.stringify(e.metadata):"",thumbnailHtml:this.generateThumbnailHtml(e),fileUrl:s,storageType:t}}generateThumbnailHtml(e){const t=e.mime||"",s=this.getCachedDataUrl(e.id),r=this.isLoading(e.id),a=this.getStorageType(e),c=this.getFileUrl(e),u="width: 80px; height: 80px; border-radius: 4px; object-fit: cover;",_="display: flex; align-items: center; justify-content: center; background: #f0f0f0; font-size: 0.7em; border-radius: 4px; cursor: pointer;";return t.startsWith("image/")?a==="disk"&&c?`<img src="${c}" alt="Thumbnail" style="${u}" loading="lazy">`:s?`<img src="${s}" alt="Thumbnail" style="${u}" loading="lazy">`:r?`<div style="${u} ${_}">Loading...</div>`:`<div style="${u} ${_}" onclick="window.loadBlobData('${e.id}')">LOAD IMAGE</div>`:t.startsWith("video/")?a==="disk"&&c?`<video style="${u}" controls muted><source src="${c}" type="${t}"></video>`:s?`<video style="${u}" controls muted><source src="${s}" type="${t}"></video>`:r?`<div style="${u} ${_}">Loading...</div>`:`<div style="${u} ${_}" onclick="window.loadBlobData('${e.id}')">LOAD VIDEO</div>`:t.startsWith("audio/")?a==="disk"&&c?`<audio style="${u}" controls><source src="${c}" type="${t}"></audio>`:s?`<audio style="${u}" controls><source src="${s}" type="${t}"></audio>`:r?`<div style="${u} ${_}">Loading...</div>`:`<div style="${u} ${_}" onclick="window.loadBlobData('${e.id}')">LOAD AUDIO</div>`:t==="application/pdf"?`<div style="${u} ${_}">PDF</div>`:`<div style="${u} ${_}">FILE</div>`}downloadBlob(e,t){const s=this.getCachedDataUrl(e);if(!s)return this.requestBlobData(e),!1;const r=this.getBlob(e),a=t||r?.local_path||`blob-${e}`,c=document.createElement("a");return c.href=s,c.download=a,document.body.appendChild(c),c.click(),document.body.removeChild(c),this.dispatchEvent(new CustomEvent("blob-downloaded",{detail:{id:e,filename:a}})),!0}viewBlob(e){const t=this.getCachedDataUrl(e);return t?(window.open(t,"_blank"),this.dispatchEvent(new CustomEvent("blob-viewed",{detail:{id:e}})),!0):(this.requestBlobData(e),!1)}getStorageType(e){return e.local_path?"disk":"database"}getFileUrl(e){if(e.local_path){const t=e.local_path.startsWith("/")?e.local_path.substring(1):e.local_path;return`${this.baseUrl}/${t}`}}updateBaseUrl(e){this.baseUrl=e.replace(/\/$/,"")}formatFileSize(e){if(!e)return"Unknown size";const t=["B","KB","MB","GB"];let s=e,r=0;for(;s>=1024&&r<t.length-1;)s/=1024,r++;return`${s.toFixed(1)} ${t[r]}`}clearCache(){for(const e of this.blobDataCache.values())URL.revokeObjectURL(e);this.blobDataCache.clear(),this.loadingBlobs.clear(),this.dispatchEvent(new CustomEvent("cache-cleared",{detail:{timestamp:Date.now()}}))}getCacheStats(){return{cachedCount:this.blobDataCache.size,loadingCount:this.loadingBlobs.size,totalBlobs:this.blobs.length}}destroy(){this.clearCache(),this.blobs=[],["blobs-updated","blob-data-cached","blob-data-requested","blob-downloaded","blob-viewed","cache-cleared"].forEach(t=>{(this._listeners?.[t]||[]).forEach(r=>{this.removeEventListener(t,r)})})}}class zt extends EventTarget{uploads=new Map;options;constructor(e={}){super(),this.options={maxFileSize:10*1024*1024,allowedMimeTypes:[],clientId:"web-client",chunkSize:64*1024,...e}}async addFiles(e){const t=Array.from(e),s=[];for(const r of t){const a=crypto.randomUUID();s.push(a);const c={file:r,id:a,progress:0,status:"pending"};this.uploads.set(a,c),this.processFile(a)}return s}getUpload(e){return this.uploads.get(e)}getAllUploads(){return Array.from(this.uploads.values())}clearCompleted(){for(const[e,t]of this.uploads.entries())(t.status==="completed"||t.status==="error")&&this.uploads.delete(e);this.dispatchEvent(new CustomEvent("uploads-cleared",{detail:{timestamp:Date.now()}}))}cancelUpload(e){const t=this.uploads.get(e);t&&t.status!=="completed"&&(t.status="error",t.error="Cancelled by user",this.dispatchEvent(new CustomEvent("upload-cancelled",{detail:{uploadId:e,file:t.file}})))}async processFile(e){const t=this.uploads.get(e);if(t)try{t.status="processing",t.progress=0,this.dispatchEvent(new CustomEvent("upload-started",{detail:{uploadId:e,file:t.file}})),this.validateFile(t.file),t.progress=10;const s=await this.readFile(t.file);t.progress=30;const r=await this.calculateSHA256(s);t.progress=60;const a=this.createProcessedBlob(t.file,s,r);t.progress=90,t.status="uploading",t.progress=100,this.dispatchEvent(new CustomEvent("upload-processed",{detail:{uploadId:e,file:t.file,blob:a}})),t.status="completed",this.dispatchEvent(new CustomEvent("upload-completed",{detail:{uploadId:e,file:t.file,blob:a}}))}catch(s){t.status="error",t.error=s instanceof Error?s.message:String(s),this.dispatchEvent(new CustomEvent("upload-error",{detail:{uploadId:e,file:t.file,error:t.error}}))}}validateFile(e){if(e.size>this.options.maxFileSize)throw new Error(`File "${e.name}" is too large (${this.formatFileSize(e.size)}). Maximum size is ${this.formatFileSize(this.options.maxFileSize)}.`);if(this.options.allowedMimeTypes.length>0){const t=e.type||"application/octet-stream";if(!this.options.allowedMimeTypes.includes(t))throw new Error(`File type "${t}" is not allowed. Allowed types: ${this.options.allowedMimeTypes.join(", ")}`)}if(e.size===0)throw new Error(`File "${e.name}" is empty.`)}readFile(e){return new Promise((t,s)=>{const r=new FileReader;r.onload=()=>{r.result instanceof ArrayBuffer?t(r.result):s(new Error("Failed to read file as ArrayBuffer"))},r.onerror=()=>{s(new Error(`Failed to read file: ${r.error?.message||"Unknown error"}`))},r.readAsArrayBuffer(e)})}async calculateSHA256(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(r=>r.toString(16).padStart(2,"0")).join("")}createProcessedBlob(e,t,s){const r=Array.from(new Uint8Array(t)),a=new Date().toISOString();return{id:crypto.randomUUID(),data:r,sha256:s,size:e.size,mime:e.type||"application/octet-stream",source_client_id:this.options.clientId,metadata:{originalName:e.name,lastModified:e.lastModified,uploadedAt:a,userAgent:navigator.userAgent},created_at:a,updated_at:a}}formatFileSize(e){if(!e)return"Unknown size";const t=["B","KB","MB","GB"];let s=e,r=0;for(;s>=1024&&r<t.length-1;)s/=1024,r++;return`${s.toFixed(1)} ${t[r]}`}getStats(){const e=Array.from(this.uploads.values());return{total:e.length,pending:e.filter(t=>t.status==="pending").length,processing:e.filter(t=>t.status==="processing").length,uploading:e.filter(t=>t.status==="uploading").length,completed:e.filter(t=>t.status==="completed").length,errors:e.filter(t=>t.status==="error").length}}updateOptions(e){this.options={...this.options,...e},this.dispatchEvent(new CustomEvent("options-updated",{detail:{options:this.options}}))}destroy(){this.uploads.clear(),["upload-started","upload-processed","upload-completed","upload-error","upload-cancelled","uploads-cleared","options-updated"].forEach(t=>{(this._listeners?.[t]||[]).forEach(r=>{this.removeEventListener(t,r)})})}}class Ft extends EventTarget{client;blobManager;uploadHandler;eventLog=[];options;constructor(e,t={}){super(),this.options={autoGetMediaBlobs:!0,logLevel:"info",...t},this.client=new Lt({url:e,debug:this.options.logLevel==="debug",...this.options.websocket}),this.blobManager=new Dt,this.uploadHandler=new zt({clientId:"demo-client",...this.options.fileUpload}),this.setupEventHandlers()}async connect(){this.log("info","Connecting to WebSocket server"),this.client.connect()}disconnect(){this.log("info","Disconnecting from WebSocket server"),this.client.disconnect()}ping(){this.log("debug","Sending ping"),this.client.ping()}getMediaBlobs(e=10,t=0){this.log("debug",`Requesting media blobs (limit: ${e}, offset: ${t})`),this.client.getMediaBlobs(e,t)}async uploadFiles(e){return this.log("info",`Starting upload of ${e.length} file(s)`),this.uploadHandler.addFiles(e)}downloadBlob(e,t){return this.log("debug",`Downloading blob: ${e}`),this.blobManager.downloadBlob(e,t)}viewBlob(e){return this.log("debug",`Viewing blob: ${e}`),this.blobManager.viewBlob(e)}loadBlobData(e){this.log("debug",`Loading blob data: ${e}`),this.client.getMediaBlobData(e)}getConnectionStatus(){return this.client.getStatus()}isConnected(){return this.client.getStatus()===Ie.Connected}getUserCount(){return 0}getConnectionId(){return""}getBlobs(){return this.blobManager.getBlobs()}getBlobDisplayInfo(e){return this.blobManager.getBlobDisplayInfo(e)}get mediaManager(){return this.blobManager}getUploadStats(){return this.uploadHandler.getStats()}getCacheStats(){return this.blobManager.getCacheStats()}clearCompletedUploads(){this.uploadHandler.clearCompleted()}clearBlobCache(){this.blobManager.clearCache()}getEventLog(){return[...this.eventLog]}clearEventLog(){this.eventLog=[],this.dispatchEvent(new CustomEvent("log-cleared",{detail:{timestamp:Date.now()}}))}setupEventHandlers(){this.client.on("statusChange",e=>{this.log("info",`Connection status changed: ${e}`),this.dispatchEvent(new CustomEvent("status-change",{detail:{status:e}})),e===Ie.Connected&&this.options.autoGetMediaBlobs&&setTimeout(()=>this.getMediaBlobs(),100)}),this.client.on("welcome",e=>{this.log("info","Welcome received",e),this.dispatchEvent(new CustomEvent("welcome",{detail:e}))}),this.client.on("error",e=>{this.log("error","Server error",e),this.dispatchEvent(new CustomEvent("server-error",{detail:e}))}),this.client.on("parseError",(e,t)=>{this.log("error","Parse error",{error:e.message,rawMessage:t}),this.dispatchEvent(new CustomEvent("parse-error",{detail:{error:e.message,rawMessage:t}}))}),this.client.on("mediaBlobs",e=>{this.handleServerMessage({type:"MediaBlobs",data:e})}),this.client.on("mediaBlob",e=>{this.handleServerMessage({type:"MediaBlob",data:e})}),this.client.on("mediaBlobData",e=>{this.handleServerMessage({type:"MediaBlobData",data:e})}),this.client.on("connectionStatus",e=>{this.handleServerMessage({type:"ConnectionStatus",data:e})}),this.blobManager.addEventListener("blobs-updated",e=>{const t=e.detail;this.log("info",`Media blobs updated: ${t.count} blobs`),this.dispatchEvent(new CustomEvent("blobs-updated",{detail:t}))}),this.blobManager.addEventListener("blob-data-requested",e=>{const{id:t}=e.detail;this.client.getMediaBlobData(t)}),this.blobManager.addEventListener("blob-data-cached",e=>{const t=e.detail;this.log("debug",`Blob data cached: ${t.id}`),this.dispatchEvent(new CustomEvent("blob-data-cached",{detail:t}))}),this.uploadHandler.addEventListener("upload-started",e=>{const{file:t}=e.detail;this.log("info",`Upload started: ${t.name}`),this.dispatchEvent(new CustomEvent("upload-started",{detail:e.detail}))}),this.uploadHandler.addEventListener("upload-completed",e=>{const{file:t,blob:s}=e.detail;this.log("info",`Upload completed: ${t.name}`),this.client.uploadMediaBlob(s),this.dispatchEvent(new CustomEvent("upload-completed",{detail:e.detail}))}),this.uploadHandler.addEventListener("upload-error",e=>{const{file:t,error:s}=e.detail;this.log("error",`Upload failed: ${t.name}`,{error:s}),this.dispatchEvent(new CustomEvent("upload-error",{detail:e.detail}))})}handleServerMessage(e){switch(e.type){case"MediaBlobs":{const t=e.data;this.log("info",`Received ${t?.blobs?.length||0} media blobs`),this.blobManager.updateBlobs(t?.blobs||[]);break}case"MediaBlob":{const s=e.data?.blob;this.log("info",`Received single media blob: ${s?.id}`);break}case"MediaBlobData":{const t=e.data;this.log("debug",`Received blob data: ${t?.id}`),t&&this.blobManager.cacheBlobData(t);break}case"Error":{const s=e.data?.message||"Server error";this.log("error",`Server error: ${s}`),this.dispatchEvent(new CustomEvent("server-error",{detail:{error:s}}));break}default:this.log("debug",`Unknown message type: ${e.type}`)}this.dispatchEvent(new CustomEvent("message",{detail:{message:e}}))}log(e,t,s){if(!this.shouldLog(e))return;const r={type:e,timestamp:Date.now(),data:{message:t,data:s}};this.eventLog.push(r),this.eventLog.length>100&&(this.eventLog=this.eventLog.slice(-100)),this.dispatchEvent(new CustomEvent("log",{detail:r}));const a=new Date().toLocaleTimeString(),c=s?`[${a}] [WebSocketDemo] ${t}: ${JSON.stringify(s,null,2)}`:`[${a}] [WebSocketDemo] ${t}`;switch(e){case"error":console.error(c);break;case"warn":console.warn(c);break;case"debug":console.debug(c);break;default:console.log(c)}}shouldLog(e){const t=["none","error","warn","info","debug"],s=t.indexOf(this.options.logLevel||"info");return t.indexOf(e)<=s}destroy(){this.log("info","Destroying WebSocket demo client"),this.client.disconnect(),this.blobManager.destroy(),this.uploadHandler.destroy(),this.eventLog=[],["status-change","welcome","blobs-updated","blob-data-cached","upload-started","upload-completed","upload-error","server-error","parse-error","message","log","log-cleared"].forEach(t=>{(this._listeners?.[t]||[]).forEach(r=>{this.removeEventListener(t,r)})})}}const Mt=le({filename:S().min(1),mime_type:S().optional(),sha256:S().length(64),size:Y().int().positive(),metadata:We(Ne()).default({})}),At=le({id:S().uuid(),local_path:S().nullish(),sha256:S(),size:Y().int().positive(),mime_type:S().optional(),created_at:S().datetime()}),je=le({id:S().uuid(),local_path:S().nullish(),sha256:S(),size:Y().int().optional(),mime:S().optional(),source_client_id:S().optional(),metadata:We(Ne()).default({}),created_at:S().datetime(),updated_at:S().datetime()}),Tt=le({uploads:xt(je),total_count:Y().int().min(0),limit:Y().int().optional(),offset:Y().int().min(0)});class H extends Error{constructor(e,t,s){super(t),this.type=e,this.originalError=s,this.name="UploadError"}}class Rt extends EventTarget{config;activeUploads=new Map;constructor(e={}){super(),this.config={baseUrl:"http://localhost:3000",minFileSize:10*1024*1024,maxFileSize:1024*1024*1024,timeoutMs:5*60*1e3,credentials:!0,...e}}async uploadFile(e,t={}){const s=crypto.randomUUID();try{this.validateFile(e);const r=new AbortController;this.activeUploads.set(s,r),this.emitProgress({uploadId:s,stage:"preparing",progress:0,totalBytes:e.size}),this.emitProgress({uploadId:s,stage:"hashing",progress:10,totalBytes:e.size});const a=await this.calculateSHA256(e);this.emitProgress({uploadId:s,stage:"hashing",progress:50,totalBytes:e.size});const c={filename:e.name,mime_type:e.type||void 0,sha256:a,size:e.size,metadata:t};Mt.parse(c),this.emitProgress({uploadId:s,stage:"uploading",progress:60,totalBytes:e.size});const u=new FormData;u.append("metadata",JSON.stringify(c)),u.append("file",e);const _=await fetch(`${this.config.baseUrl}/api/upload`,{method:"POST",body:u,credentials:this.config.credentials?"include":"omit",signal:r.signal});if(this.emitProgress({uploadId:s,stage:"uploading",progress:90,bytesUploaded:e.size,totalBytes:e.size}),!_.ok)throw await this.handleErrorResponse(_);const se=await _.json(),re=At.parse(se);return this.emitProgress({uploadId:s,stage:"completed",progress:100,bytesUploaded:e.size,totalBytes:e.size}),re}catch(r){const a=r instanceof H?r:new H("SERVER_ERROR",r instanceof Error?r.message:String(r),r instanceof Error?r:void 0);throw this.emitProgress({uploadId:s,stage:"error",progress:0,error:a}),a}finally{this.activeUploads.delete(s)}}async getUploadInfo(e){const t=await fetch(`${this.config.baseUrl}/api/upload/${e}`,{method:"GET",credentials:this.config.credentials?"include":"omit"});if(!t.ok)throw await this.handleErrorResponse(t);const s=await t.json();return je.parse(s)}async listUploads(e={}){const t=new URLSearchParams;e.limit!==void 0&&t.set("limit",e.limit.toString()),e.offset!==void 0&&t.set("offset",e.offset.toString());const s=`${this.config.baseUrl}/api/uploads${t.toString()?`?${t}`:""}`,r=await fetch(s,{method:"GET",credentials:this.config.credentials?"include":"omit"});if(!r.ok)throw await this.handleErrorResponse(r);const a=await r.json();return Tt.parse(a)}async deleteUpload(e){const t=await fetch(`${this.config.baseUrl}/api/upload/${e}`,{method:"DELETE",credentials:this.config.credentials?"include":"omit"});if(!t.ok)throw await this.handleErrorResponse(t)}cancelUpload(e){const t=this.activeUploads.get(e);return t?(t.abort(),this.activeUploads.delete(e),!0):!1}cancelAllUploads(){for(const e of this.activeUploads.values())e.abort();this.activeUploads.clear()}getActiveUploadCount(){return this.activeUploads.size}updateConfig(e){this.config={...this.config,...e}}validateFile(e){if(e.size<this.config.minFileSize)throw new H("FILE_TOO_SMALL",`File size ${this.formatFileSize(e.size)} is below the minimum of ${this.formatFileSize(this.config.minFileSize)}`);if(e.size>this.config.maxFileSize)throw new H("FILE_TOO_LARGE",`File size ${this.formatFileSize(e.size)} exceeds the maximum of ${this.formatFileSize(this.config.maxFileSize)}`);if(e.size===0)throw new H("INVALID_FILE","File is empty");if(e.name.includes("..")||e.name.includes("/")||e.name.includes("\\"))throw new H("INVALID_FILE","Invalid filename")}async calculateSHA256(e){try{const t=await e.arrayBuffer(),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(a=>a.toString(16).padStart(2,"0")).join("")}catch(t){throw new H("HASH_CALCULATION_FAILED","Failed to calculate file hash",t instanceof Error?t:void 0)}}async handleErrorResponse(e){let t,s;try{const r=await e.json();t=r.error||r.message||`HTTP ${e.status}`}catch{t=`HTTP ${e.status} ${e.statusText}`}switch(e.status){case 400:s="INVALID_FILE";break;case 401:s="UNAUTHORIZED";break;case 403:s="FORBIDDEN";break;case 409:s="CONFLICT";break;case 413:s="FILE_TOO_LARGE";break;default:s=e.status>=500?"SERVER_ERROR":"NETWORK_ERROR"}return new H(s,t)}emitProgress(e){this.dispatchEvent(new CustomEvent("upload-progress",{detail:e}))}formatFileSize(e){if(!e)return"0 B";const t=["B","KB","MB","GB"];let s=e,r=0;for(;s>=1024&&r<t.length-1;)s/=1024,r++;return`${s.toFixed(1)} ${t[r]}`}static shouldUseHttpUpload(e,t=10*1024*1024){return e.size>=t}static formatFileSize(e){if(!e)return"0 B";const t=["B","KB","MB","GB"];let s=e,r=0;for(;s>=1024&&r<t.length-1;)s/=1024,r++;return`${s.toFixed(1)} ${t[r]}`}}var Ht=f("<div>⚠️ Large file uploads (≥10MB) require admin privileges"),Ot=f("<div><h3>Upload Progress (<!> active)</h3><button>Clear Progress"),It=f("<div class=blob-list>"),Wt=f("<div>No log entries yet..."),Nt=f("<div class=demo-section><h2 class=section-title>Debug Log</h2><div class=controls><button>Clear Log</button></div><div class=log-container>"),jt=f(`<div><style>
        .demo-section { margin-bottom: 2rem; }
        .controls { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
        button {
          padding: 0.5rem 1rem;
          border: 1px solid #ccc;
          background: white;
          cursor: pointer;
          border-radius: 4px;
          font-size: 0.875rem;
          font-weight: 500;
        }
        button:hover:not(:disabled) { background: #f0f0f0; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
        button.primary:hover:not(:disabled) { background: #2563eb; }
        input[type="text"] {
          padding: 0.5rem;
          border: 1px solid #ccc;
          border-radius: 4px;
          min-width: 300px;
          font-size: 0.875rem;
        }
        .status-indicator {
          display: inline-block;
          width: 12px;
          height: 12px;
          border-radius: 50%;
          margin-right: 0.5rem;
        }
        .log-container {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 1rem;
          max-height: 300px;
          overflow-y: auto;
          font-family: monospace;
          font-size: 0.875rem;
          white-space: pre-wrap;
        }
        .blob-list { display: grid; gap: 1rem; }
        .blob-item {
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 1rem;
          background: white;
        }
        .blob-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 0.5rem;
        }
        .blob-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .blob-actions button {
          font-size: 0.75rem;
          padding: 0.25rem 0.5rem;
          font-weight: normal;
        }
        .blob-actions a {
          color: #3b82f6;
          text-decoration: none;
          font-size: 0.75rem;
        }
        .blob-actions a:hover {
          text-decoration: underline;
        }
        .section-title {
          margin: 0 0 1rem 0;
          color: #374151;
          font-weight: 600;
        }
        .empty-state {
          text-align: center;
          padding: 2rem;
          color: #6b7280;
          font-style: italic;
        }
        .smart-upload-zone {
          border: 2px dashed #d1d5db;
          border-radius: 8px;
          padding: 2rem;
          text-align: center;
          margin: 1rem 0;
          background: #fafafa;
          transition: all 0.2s ease;
          cursor: pointer;
        }
        .smart-upload-zone:hover {
          border-color: #3b82f6;
          background: #eff6ff;
        }
        .smart-upload-zone.disabled {
          opacity: 0.5;
          cursor: not-allowed;
          pointer-events: none;
        }
        .upload-status {
          background: #f3f4f6;
          border-radius: 6px;
          padding: 0.75rem;
          margin: 0.5rem 0;
          font-size: 0.875rem;
        }
        .upload-status.success {
          background: #d1fae5;
          color: #065f46;
        }
        .upload-status.error {
          background: #fee2e2;
          color: #991b1b;
        }
        .user-role {
          display: inline-block;
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          font-size: 0.75rem;
          font-weight: 500;
          margin-left: 0.5rem;
        }
        .user-role.admin {
          background: #d1fae5;
          color: #065f46;
        }
        .user-role.member {
          background: #dbeafe;
          color: #1e40af;
        }
      </style><h1>WebSocket Demo (Modular Components)</h1><div class=demo-section><h2 class=section-title>Connection</h2><div class=controls><input type=text placeholder="WebSocket URL"><button class=primary>Connect</button><button>Disconnect</button></div><div><span class=status-indicator></span>Status: <span></span></div></div><div class=demo-section><h2 class=section-title>Smart File Upload</h2><p>Drag & drop files or click to select. Files are automatically routed:<br>• &lt;10MB: WebSocket → Database (any user)<br>• ≥10MB: HTTP API → Disk (admin only)</p><div><div>📁</div><div>Drop files here or click to upload</div><div>Smart routing: Small files via WebSocket, large files via HTTP</div></div><input type=file multiple><div class=controls><button>Ping</button><button>Refresh Media Blobs</button><button>Clear Log</button></div></div><div class=demo-section><h2 class=section-title>Upload Capabilities</h2><div><div><div>💾 Small Files (&lt;10MB)</div><div>• Method: WebSocket<br>• Storage: Database (BYTEA)<br>• Access: Any authenticated user<br>• Status: </div></div><div><div>🗄️ Large Files (≥10MB)</div><div>• Method: HTTP API<br>• Storage: Disk files<br>• Access: Admin users only<br>• Status: </div></div></div></div><div class=demo-section><h2 class=section-title>Media Library (<!> files)<span> disk, <!> database`),qt=f("<div>: <!>%"),Gt=f("<span> (<!> / <!>)"),Vt=f("<div class=empty-state>No media blobs yet. Upload a file or get blobs from server."),Kt=f("<button>🚀 Open File"),Jt=f("<button>👁️ Preview"),Yt=f("<button>📊 Load Data"),Zt=f("<div class=blob-item><div class=blob-header><div><strong></strong><br><small> • </small><br><small></small></div><div></div></div><div><small><br>Created: <br>Source: </small></div><div class=blob-actions><button>📥 Download"),Qt=f("<span>🗄️ Disk (Large file)"),Xt=f("<span>💾 Database (Small file)"),es=f("<br>"),ts=f("<a target=_blank rel=noopener>🔗 Direct file access"),ss=f("<div>");const rs=z=>{const[e,t]=C(null),[s,r]=C("disconnected"),[a,c]=C(0),[u,_]=C([]),[se,re]=C([]),[qe,Ge]=C(0),[we,Se]=C("ws://localhost:8080/ws"),[_e]=C("http://localhost:8080"),[D,Ee]=C(!1),[de,ce]=C(new Map),[Ve,Ke]=C(null);Oe(()=>{const n=z.websocketUrl;n&&Se(n)});let ue;window.loadBlobData=n=>{e()?.loadBlobData(n)},Oe(()=>{const n=we(),h=new Ft(n,{logLevel:"info",autoGetMediaBlobs:!0}),y=new Rt({baseUrl:_e(),minFileSize:10*1024*1024,maxFileSize:1024*1024*1024});y.addEventListener("upload-progress",l=>{const E=l.detail;ce(P=>{const $=new Map(P);return $.set(E.uploadId,E),$})}),Ke(y),h.addEventListener("status-change",l=>{const{status:E,userCount:P}=l.detail;r(E),c(P||0)}),h.addEventListener("blobs-updated",l=>{const E=l.detail.blobs;_(E),h.mediaManager?.updateBaseUrl(_e())}),h.addEventListener("blob-data-cached",()=>{Ge(l=>l+1)}),h.addEventListener("log",l=>{const{message:E,data:P}=l.detail.data,$=P?`${E}: ${JSON.stringify(P)}`:E;re(O=>[...O.slice(-49),$])}),t(h),fetch("/api/whoami",{credentials:"include"}).then(l=>l.json()).then(l=>{Ee(l.role==="admin")}).catch(()=>{Ee(!1)}),z.autoConnect&&h.connect().catch(console.error),Pt(()=>{h.destroy(),y.cancelAllUploads()})});const Je=()=>{e()?.connect().catch(console.error)},Ye=()=>{e()?.disconnect()},Ze=()=>{e()?.ping()},xe=()=>{e()?.getMediaBlobs()},Qe=n=>{const h=n.target,y=h.files;y&&y.length>0&&(Ce(Array.from(y)),h.value="")},Xe=()=>{ue?.click()},Ce=async n=>{const h=e(),y=Ve();if(!h||s()!=="connected"){console.error("WebSocket not connected");return}for(const l of n){const E=l.size;if(E>=10*1024*1024){if(!D()){console.error(`File "${l.name}" is ${he(E)} which requires admin access`);continue}if(!y){console.error("HTTP uploader not available");continue}try{const $=await y.uploadFile(l,{uploadedVia:"websocket-demo",originalMethod:"http"});console.log(`Large file uploaded successfully: ${l.name}`,$),xe(),setTimeout(()=>{ce(O=>{const j=new Map(O);for(const[q,Z]of j.entries())Z.stage==="completed"&&j.delete(q);return j})},3e3)}catch($){console.error(`Failed to upload large file "${l.name}":`,$)}}else try{await h.uploadFiles([l]),console.log(`Small file uploaded successfully: ${l.name}`)}catch($){console.error(`Failed to upload small file "${l.name}":`,$)}}},et=n=>{n.preventDefault(),n.dataTransfer?.files&&Ce(Array.from(n.dataTransfer.files))},tt=n=>{n.preventDefault()},he=n=>{if(!n)return"0 B";const h=["B","KB","MB","GB"];let y=n,l=0;for(;y>=1024&&l<h.length-1;)y/=1024,l++;return`${y.toFixed(1)} ${h[l]}`},st=(n,h)=>{e()?.downloadBlob(n,h)},rt=n=>{e()?.viewBlob(n)},it=n=>{e()?.loadBlobData(n)},Be=()=>{re([]),e()?.clearEventLog()},ot=()=>{switch(s()){case"connected":return"#10b981";case"connecting":return"#f59e0b";case"error":return"#ef4444";default:return"#6b7280"}};return(()=>{var n=jt(),h=n.firstChild,y=h.nextSibling,l=y.nextSibling,E=l.firstChild,P=E.nextSibling,$=P.firstChild,O=$.nextSibling,j=O.nextSibling,q=P.nextSibling,Z=q.firstChild,at=Z.nextSibling,ie=at.nextSibling,pe=l.nextSibling,nt=pe.firstChild,oe=nt.nextSibling,I=oe.nextSibling,ge=I.firstChild,me=ge.nextSibling,Pe=me.nextSibling,G=I.nextSibling,Ue=G.nextSibling,be=Ue.firstChild,fe=be.nextSibling,lt=fe.nextSibling,ke=pe.nextSibling,dt=ke.firstChild,Q=dt.nextSibling,V=Q.firstChild,ae=V.firstChild,ne=ae.nextSibling,ct=ne.firstChild,ut=ct.nextSibling,ht=ut.nextSibling,pt=ht.nextSibling,gt=pt.nextSibling,mt=gt.nextSibling;mt.nextSibling;var W=V.nextSibling,X=W.firstChild,ee=X.nextSibling,bt=ee.firstChild,ft=bt.nextSibling,yt=ft.nextSibling,vt=yt.nextSibling,$t=vt.nextSibling,wt=$t.nextSibling;wt.nextSibling;var Le=ke.nextSibling,De=Le.firstChild,St=De.firstChild,ze=St.nextSibling,_t=ze.nextSibling,N=_t.nextSibling,Fe=N.firstChild,Me=Fe.nextSibling;Me.nextSibling,n.style.setProperty("padding","1rem"),n.style.setProperty("font-family","sans-serif"),$.$$input=i=>Se(i.target.value),O.$$click=Je,j.$$click=Ye,q.style.setProperty("margin-bottom","1rem"),o(q,s,ie),o(q,B(R,{get when(){return a()>0},get children(){return[" ","(",J(()=>a())," user",J(()=>a()!==1?"s":"")," online)"]}}),ie),o(ie,()=>D()?"Admin":"Member"),oe.style.setProperty("color","#6b7280"),oe.style.setProperty("margin-bottom","1rem"),oe.style.setProperty("font-size","0.875rem"),I.addEventListener("dragover",tt),I.addEventListener("drop",et),I.$$click=Xe,ge.style.setProperty("font-size","2rem"),ge.style.setProperty("margin-bottom","0.5rem"),me.style.setProperty("font-weight","500"),me.style.setProperty("margin-bottom","0.5rem"),Pe.style.setProperty("font-size","0.875rem"),Pe.style.setProperty("color","#6b7280"),o(I,B(R,{get when(){return!D()},get children(){var i=Ht();return i.style.setProperty("font-size","0.75rem"),i.style.setProperty("color","#dc2626"),i.style.setProperty("margin-top","0.5rem"),i}}),null),G.addEventListener("change",Qe);var Ae=ue;return typeof Ae=="function"?kt(Ae,G):ue=G,G.style.setProperty("display","none"),Ue.style.setProperty("margin-top","1rem"),be.$$click=Ze,fe.$$click=xe,lt.$$click=Be,o(pe,B(R,{get when(){return de().size>0},get children(){var i=Ot(),p=i.firstChild,v=p.firstChild,U=v.nextSibling;U.nextSibling;var m=p.nextSibling;return i.style.setProperty("margin-top","1rem"),p.style.setProperty("margin-bottom","0.5rem"),p.style.setProperty("font-size","1rem"),o(p,()=>de().size,U),o(i,B(ve,{get each(){return Array.from(de().values())},children:d=>(()=>{var b=qt(),k=b.firstChild,L=k.nextSibling;return L.nextSibling,o(b,()=>d.stage==="completed"&&"✅ ",k),o(b,()=>d.stage==="error"&&"❌ ",k),o(b,()=>d.stage==="uploading"&&"📤 ",k),o(b,()=>d.stage,k),o(b,()=>d.progress,L),o(b,(()=>{var K=J(()=>!!(d.bytesUploaded&&d.totalBytes));return()=>K()&&(()=>{var x=Gt(),F=x.firstChild,M=F.nextSibling,A=M.nextSibling,T=A.nextSibling;return T.nextSibling,x.style.setProperty("color","#6b7280"),o(x,()=>he(d.bytesUploaded),M),o(x,()=>he(d.totalBytes),T),x})()})(),null),o(b,()=>d.error&&` - ${d.error.message}`,null),te(()=>$e(b,`upload-status ${d.stage==="completed"?"success":d.stage==="error"?"error":""}`)),b})()}),m),m.$$click=()=>ce(new Map),m.style.setProperty("margin-top","0.5rem"),m.style.setProperty("padding","0.25rem 0.5rem"),m.style.setProperty("font-size","0.75rem"),m.style.setProperty("background","#f3f4f6"),m.style.setProperty("border","1px solid #d1d5db"),m.style.setProperty("border-radius","4px"),m.style.setProperty("cursor","pointer"),i}}),null),Q.style.setProperty("display","grid"),Q.style.setProperty("grid-template-columns","1fr 1fr"),Q.style.setProperty("gap","1rem"),Q.style.setProperty("margin-bottom","1rem"),V.style.setProperty("background","#dbeafe"),V.style.setProperty("padding","1rem"),V.style.setProperty("border-radius","6px"),V.style.setProperty("border","1px solid #93c5fd"),ae.style.setProperty("font-weight","500"),ae.style.setProperty("color","#1e40af"),ae.style.setProperty("margin-bottom","0.5rem"),ne.style.setProperty("font-size","0.875rem"),ne.style.setProperty("color","#1e40af"),o(ne,()=>s()==="connected"?"✅ Available":"❌ Requires connection",null),W.style.setProperty("padding","1rem"),W.style.setProperty("border-radius","6px"),X.style.setProperty("font-weight","500"),X.style.setProperty("margin-bottom","0.5rem"),ee.style.setProperty("font-size","0.875rem"),o(ee,()=>D()?"✅ Available":"❌ Admin required",null),o(De,()=>u().length,ze),N.style.setProperty("font-size","0.875rem"),N.style.setProperty("font-weight","normal"),N.style.setProperty("color","#6b7280"),N.style.setProperty("margin-left","0.5rem"),o(N,()=>u().filter(i=>i.local_path).length,Fe),o(N,()=>u().filter(i=>!i.local_path).length,Me),o(Le,B(R,{get when(){return u().length>0},get fallback(){return Vt()},get children(){var i=It();return o(i,B(ve,{get each(){return u()},children:p=>{const v=()=>(qe(),e()?.getBlobDisplayInfo(p));return(()=>{var U=Zt(),m=U.firstChild,d=m.firstChild,b=d.firstChild,k=b.nextSibling,L=k.nextSibling,K=L.firstChild,x=L.nextSibling,F=x.nextSibling,M=d.nextSibling,A=m.nextSibling,T=A.firstChild,Te=T.firstChild,Et=Te.nextSibling,Re=Et.nextSibling;Re.nextSibling;var ye=A.nextSibling,He=ye.firstChild;return o(b,()=>p.id),o(L,()=>v()?.mime,K),o(L,()=>v()?.size,null),F.style.setProperty("color","#6b7280"),o(F,(()=>{var w=J(()=>v()?.storageType==="disk");return()=>w()?(()=>{var g=Qt();return g.style.setProperty("background","#d1fae5"),g.style.setProperty("color","#065f46"),g.style.setProperty("padding","0.125rem 0.5rem"),g.style.setProperty("border-radius","4px"),g.style.setProperty("font-size","0.75rem"),g.style.setProperty("font-weight","500"),g})():(()=>{var g=Xt();return g.style.setProperty("background","#dbeafe"),g.style.setProperty("color","#1e40af"),g.style.setProperty("padding","0.125rem 0.5rem"),g.style.setProperty("border-radius","4px"),g.style.setProperty("font-size","0.75rem"),g.style.setProperty("font-weight","500"),g})()})()),T.style.setProperty("color","#6b7280"),o(T,(()=>{var w=J(()=>!!p.local_path);return()=>w()?["Path: ",J(()=>p.local_path),es(),(()=>{var g=ts();return g.style.setProperty("color","#3b82f6"),g.style.setProperty("text-decoration","none"),te(()=>Ut(g,"href",v()?.fileUrl)),g})()]:"Stored in database"})(),Te),o(T,()=>new Date(p.created_at).toLocaleString(),Re),o(T,()=>p.source_client_id||"Unknown",null),o(ye,B(R,{get when(){return v()?.storageType==="disk"},get children(){var w=Kt();return w.$$click=()=>window.open(v()?.fileUrl,"_blank"),w.style.setProperty("background","#10b981"),w.style.setProperty("color","white"),w.style.setProperty("border","none"),w}}),He),He.$$click=()=>st(p.id,p.local_path),o(ye,B(R,{get when(){return v()?.storageType==="database"},get children(){return[(()=>{var w=Jt();return w.$$click=()=>rt(p.id),w})(),(()=>{var w=Yt();return w.$$click=()=>it(p.id),w})()]}}),null),te(()=>M.innerHTML=v()?.thumbnailHtml),U})()}})),i}}),null),o(n,B(R,{get when(){return z.showDebugLog},get children(){var i=Nt(),p=i.firstChild,v=p.nextSibling,U=v.firstChild,m=v.nextSibling;return U.$$click=Be,o(m,B(ve,{get each(){return se()},children:d=>(()=>{var b=ss();return o(b,d),b})()}),null),o(m,B(R,{get when(){return se().length===0},get children(){var d=Wt();return d.style.setProperty("color","#6b7280"),d.style.setProperty("font-style","italic"),d}}),null),i}}),null),te(i=>{var p=s()==="connected"||s()==="connecting",v=s()==="connected"||s()==="connecting",U=s()==="disconnected",m=ot(),d=`user-role ${D()?"admin":"member"}`,b=`smart-upload-zone ${s()!=="connected"?"disabled":""}`,k=s()!=="connected",L=s()!=="connected",K=s()!=="connected",x=D()?"#d1fae5":"#fee2e2",F=D()?"1px solid #86efac":"1px solid #fca5a5",M=D()?"#065f46":"#991b1b",A=D()?"#065f46":"#991b1b";return p!==i.e&&($.disabled=i.e=p),v!==i.t&&(O.disabled=i.t=v),U!==i.a&&(j.disabled=i.a=U),m!==i.o&&((i.o=m)!=null?Z.style.setProperty("background-color",m):Z.style.removeProperty("background-color")),d!==i.i&&$e(ie,i.i=d),b!==i.n&&$e(I,i.n=b),k!==i.s&&(G.disabled=i.s=k),L!==i.h&&(be.disabled=i.h=L),K!==i.r&&(fe.disabled=i.r=K),x!==i.d&&((i.d=x)!=null?W.style.setProperty("background",x):W.style.removeProperty("background")),F!==i.l&&((i.l=F)!=null?W.style.setProperty("border",F):W.style.removeProperty("border")),M!==i.u&&((i.u=M)!=null?X.style.setProperty("color",M):X.style.removeProperty("color")),A!==i.c&&((i.c=A)!=null?ee.style.setProperty("color",A):ee.style.removeProperty("color")),i},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0}),te(()=>$.value=we()),n})()};Ct("websocket-demo",{websocketUrl:"ws://localhost:8080/ws",autoConnect:!1,showDebugLog:!0},rs);Bt(["input","click"]);export{Rt as F,zt as W};
//# sourceMappingURL=websocket-demo.js.map

  </script>
</body>
</html>