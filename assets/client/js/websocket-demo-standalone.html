<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebSocket Demo - Modular Components</title>
</head>
<body>
  <websocket-demo websocketUrl="ws://localhost:8080/ws" autoConnect="false" showDebugLog="true"></websocket-demo>

  <script type="module">
import{h as le,x as We,n as Y,j as S,m as Ne,k as Et,b as Ct,d as Pt,a as P,e as Ie,o as kt,t as m,i as n,c as k,w as R,S as H,F as ve,f as te,g as $e,s as Bt,u as Ut}from"./types-CptiQF1l.js";import{W as Lt,C as Oe}from"./websocket-client-BZNd2INk.js";class zt extends EventTarget{blobs=[];blobDataCache=new Map;loadingBlobs=new Set;baseUrl;constructor(e="http://localhost:8080"){super(),this.baseUrl=e.replace(/\/$/,"")}updateBlobs(e){this.blobs=[...e],this.blobs.forEach(t=>{t.mime?.startsWith("image/")&&!t.local_path&&!this.isCached(t.id)&&!this.isLoading(t.id)&&setTimeout(()=>this.requestBlobData(t.id),100)}),this.dispatchEvent(new CustomEvent("blobs-updated",{detail:{blobs:this.blobs,count:this.blobs.length}}))}getBlobs(){return[...this.blobs]}getBlob(e){return this.blobs.find(t=>t.id===e)}cacheBlobData(e){if(!e.id||!e.data)return;const t=new Uint8Array(e.data),r=new Blob([t],{type:e.mime||"application/octet-stream"}),s=URL.createObjectURL(r);this.blobDataCache.set(e.id,s),this.loadingBlobs.delete(e.id),this.dispatchEvent(new CustomEvent("blob-data-cached",{detail:{id:e.id,dataUrl:s,mime:e.mime}}))}isCached(e){return this.blobDataCache.has(e)}getCachedDataUrl(e){return this.blobDataCache.get(e)}isLoading(e){return this.loadingBlobs.has(e)}markAsLoading(e){this.loadingBlobs.add(e)}requestBlobData(e){this.isCached(e)||this.isLoading(e)||(this.markAsLoading(e),this.dispatchEvent(new CustomEvent("blob-data-requested",{detail:{id:e}})))}getBlobDisplayInfo(e){const t=this.getStorageType(e),r=this.getFileUrl(e);return{id:e.id,mime:e.mime||"Unknown type",size:this.formatFileSize(e.size),sha256:e.sha256,clientId:e.source_client_id||"Unknown",path:e.local_path||"None",createdAt:new Date(e.created_at).toLocaleString(),metadata:Object.keys(e.metadata||{}).length>0?JSON.stringify(e.metadata):"",thumbnailHtml:this.generateThumbnailHtml(e),fileUrl:r,storageType:t}}generateThumbnailHtml(e){const t=e.mime||"",r=this.getCachedDataUrl(e.id),s=this.isLoading(e.id),a=this.getStorageType(e),c=this.getFileUrl(e),p="width: 80px; height: 80px; border-radius: 4px; object-fit: cover;",_="display: flex; align-items: center; justify-content: center; background: #f0f0f0; font-size: 0.7em; border-radius: 4px; cursor: pointer;";return t.startsWith("image/")?a==="disk"&&c?`<img src="${c}" alt="Thumbnail" style="${p}" loading="lazy">`:r?`<img src="${r}" alt="Thumbnail" style="${p}" loading="lazy">`:s?`<div style="${p} ${_}">Loading...</div>`:`<div style="${p} ${_}" onclick="window.loadBlobData('${e.id}')">LOAD IMAGE</div>`:t.startsWith("video/")?a==="disk"&&c?this.generateVideoElement(c,t,p):r?this.generateVideoElement(r,t,p):s?`<div style="${p} ${_}">Loading...</div>`:`<div style="${p} ${_}" onclick="window.loadBlobData('${e.id}')">LOAD VIDEO</div>`:t.startsWith("audio/")?a==="disk"&&c?`<audio style="${p}" controls><source src="${c}" type="${t}"></audio>`:r?`<audio style="${p}" controls><source src="${r}" type="${t}"></audio>`:s?`<div style="${p} ${_}">Loading...</div>`:`<div style="${p} ${_}" onclick="window.loadBlobData('${e.id}')">LOAD AUDIO</div>`:t==="application/pdf"?`<div style="${p} ${_}">PDF</div>`:`<div style="${p} ${_}">FILE</div>`}generateVideoElement(e,t,r){const s=t==="video/quicktime"||e.toLowerCase().endsWith(".mov"),a=this.getBrowserInfo();return s&&!a.supportsMov?`
        <div style="${r} display: flex; align-items: center; justify-content: center; font-size: 0.6em; text-align: center; padding: 8px; background: #fef3c7; color: #92400e; border-radius: 4px; flex-direction: column;">
          <div style="font-weight: bold; margin-bottom: 4px;">📹 Video format not supported in ${a.name}</div>
          <div style="margin-bottom: 6px;">This .mov file works best in Safari</div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
            <a href="${e}" target="_blank" style="color: #92400e; text-decoration: underline; font-size: 0.9em;">📥 Download file</a>
            <span style="color: #6b7280;">•</span>
            <span style="font-size: 0.8em; color: #6b7280;">Try Safari browser</span>
          </div>
        </div>
      `:`<video style="${r}" ${s?'controls muted preload="metadata" playsinline':'controls muted preload="metadata"'}><source src="${e}" type="${t}">Your browser does not support this video format. <a href="${e}" target="_blank">Download to view</a></video>`}getBrowserInfo(){const e=navigator.userAgent.toLowerCase();let t="Unknown";e.includes("safari")&&!e.includes("chrome")?t="Safari":e.includes("chrome")?t="Chrome":e.includes("firefox")?t="Firefox":e.includes("edge")&&(t="Edge");const r=this.canPlayVideoType("video/quicktime");return{name:t,supportsMov:r}}canPlayVideoType(e){try{const r=document.createElement("video").canPlayType(e);return r==="probably"||r==="maybe"}catch{return!1}}downloadBlob(e,t){const r=this.getCachedDataUrl(e);if(!r)return this.requestBlobData(e),!1;const s=this.getBlob(e),a=t||s?.local_path||`blob-${e}`,c=document.createElement("a");return c.href=r,c.download=a,document.body.appendChild(c),c.click(),document.body.removeChild(c),this.dispatchEvent(new CustomEvent("blob-downloaded",{detail:{id:e,filename:a}})),!0}viewBlob(e){const t=this.getCachedDataUrl(e);return t?(window.open(t,"_blank"),this.dispatchEvent(new CustomEvent("blob-viewed",{detail:{id:e}})),!0):(this.requestBlobData(e),!1)}getStorageType(e){return e.local_path?"disk":"database"}getFileUrl(e){if(e.local_path){const t=e.local_path.startsWith("/")?e.local_path.substring(1):e.local_path;return`${this.baseUrl}/${t}`}}updateBaseUrl(e){this.baseUrl=e.replace(/\/$/,"")}formatFileSize(e){if(!e)return"Unknown size";const t=["B","KB","MB","GB"];let r=e,s=0;for(;r>=1024&&s<t.length-1;)r/=1024,s++;return`${r.toFixed(1)} ${t[s]}`}clearCache(){for(const e of this.blobDataCache.values())URL.revokeObjectURL(e);this.blobDataCache.clear(),this.loadingBlobs.clear(),this.dispatchEvent(new CustomEvent("cache-cleared",{detail:{timestamp:Date.now()}}))}getCacheStats(){return{cachedCount:this.blobDataCache.size,loadingCount:this.loadingBlobs.size,totalBlobs:this.blobs.length}}destroy(){this.clearCache(),this.blobs=[],["blobs-updated","blob-data-cached","blob-data-requested","blob-downloaded","blob-viewed","cache-cleared"].forEach(t=>{(this._listeners?.[t]||[]).forEach(s=>{this.removeEventListener(t,s)})})}}class Dt extends EventTarget{uploads=new Map;options;constructor(e={}){super(),this.options={maxFileSize:10*1024*1024,allowedMimeTypes:[],clientId:"web-client",chunkSize:64*1024,...e}}async addFiles(e){const t=Array.from(e),r=[];for(const s of t){const a=crypto.randomUUID();r.push(a);const c={file:s,id:a,progress:0,status:"pending"};this.uploads.set(a,c),this.processFile(a)}return r}getUpload(e){return this.uploads.get(e)}getAllUploads(){return Array.from(this.uploads.values())}clearCompleted(){for(const[e,t]of this.uploads.entries())(t.status==="completed"||t.status==="error")&&this.uploads.delete(e);this.dispatchEvent(new CustomEvent("uploads-cleared",{detail:{timestamp:Date.now()}}))}cancelUpload(e){const t=this.uploads.get(e);t&&t.status!=="completed"&&(t.status="error",t.error="Cancelled by user",this.dispatchEvent(new CustomEvent("upload-cancelled",{detail:{uploadId:e,file:t.file}})))}async processFile(e){const t=this.uploads.get(e);if(t)try{t.status="processing",t.progress=0,this.dispatchEvent(new CustomEvent("upload-started",{detail:{uploadId:e,file:t.file}})),this.validateFile(t.file),t.progress=10;const r=await this.readFile(t.file);t.progress=30;const s=await this.calculateSHA256(r);t.progress=60;const a=this.createProcessedBlob(t.file,r,s);t.progress=90,t.status="uploading",t.progress=100,this.dispatchEvent(new CustomEvent("upload-processed",{detail:{uploadId:e,file:t.file,blob:a}})),t.status="completed",this.dispatchEvent(new CustomEvent("upload-completed",{detail:{uploadId:e,file:t.file,blob:a}}))}catch(r){t.status="error",t.error=r instanceof Error?r.message:String(r),this.dispatchEvent(new CustomEvent("upload-error",{detail:{uploadId:e,file:t.file,error:t.error}}))}}validateFile(e){if(e.size>this.options.maxFileSize)throw new Error(`File "${e.name}" is too large (${this.formatFileSize(e.size)}). Maximum size is ${this.formatFileSize(this.options.maxFileSize)}.`);if(this.options.allowedMimeTypes.length>0){const t=e.type||"application/octet-stream";if(!this.options.allowedMimeTypes.includes(t))throw new Error(`File type "${t}" is not allowed. Allowed types: ${this.options.allowedMimeTypes.join(", ")}`)}if(e.size===0)throw new Error(`File "${e.name}" is empty.`)}readFile(e){return new Promise((t,r)=>{const s=new FileReader;s.onload=()=>{s.result instanceof ArrayBuffer?t(s.result):r(new Error("Failed to read file as ArrayBuffer"))},s.onerror=()=>{r(new Error(`Failed to read file: ${s.error?.message||"Unknown error"}`))},s.readAsArrayBuffer(e)})}async calculateSHA256(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(s=>s.toString(16).padStart(2,"0")).join("")}createProcessedBlob(e,t,r){const s=Array.from(new Uint8Array(t)),a=new Date().toISOString();return{id:crypto.randomUUID(),data:s,sha256:r,size:e.size,mime:e.type||"application/octet-stream",source_client_id:this.options.clientId,metadata:{originalName:e.name,lastModified:e.lastModified,uploadedAt:a,userAgent:navigator.userAgent},created_at:a,updated_at:a}}formatFileSize(e){if(!e)return"Unknown size";const t=["B","KB","MB","GB"];let r=e,s=0;for(;r>=1024&&s<t.length-1;)r/=1024,s++;return`${r.toFixed(1)} ${t[s]}`}getStats(){const e=Array.from(this.uploads.values());return{total:e.length,pending:e.filter(t=>t.status==="pending").length,processing:e.filter(t=>t.status==="processing").length,uploading:e.filter(t=>t.status==="uploading").length,completed:e.filter(t=>t.status==="completed").length,errors:e.filter(t=>t.status==="error").length}}updateOptions(e){this.options={...this.options,...e},this.dispatchEvent(new CustomEvent("options-updated",{detail:{options:this.options}}))}destroy(){this.uploads.clear(),["upload-started","upload-processed","upload-completed","upload-error","upload-cancelled","uploads-cleared","options-updated"].forEach(t=>{(this._listeners?.[t]||[]).forEach(s=>{this.removeEventListener(t,s)})})}}class Ft extends EventTarget{client;blobManager;uploadHandler;eventLog=[];options;constructor(e,t={}){super(),this.options={autoGetMediaBlobs:!0,logLevel:"info",...t},this.client=new Lt({url:e,debug:this.options.logLevel==="debug",...this.options.websocket}),this.blobManager=new zt,this.uploadHandler=new Dt({clientId:"demo-client",...this.options.fileUpload}),this.setupEventHandlers()}async connect(){this.log("info","Connecting to WebSocket server"),this.client.connect()}disconnect(){this.log("info","Disconnecting from WebSocket server"),this.client.disconnect()}ping(){this.log("debug","Sending ping"),this.client.ping()}getMediaBlobs(e=10,t=0){this.log("debug",`Requesting media blobs (limit: ${e}, offset: ${t})`),this.client.getMediaBlobs(e,t)}async uploadFiles(e){return this.log("info",`Starting upload of ${e.length} file(s)`),this.uploadHandler.addFiles(e)}downloadBlob(e,t){return this.log("debug",`Downloading blob: ${e}`),this.blobManager.downloadBlob(e,t)}viewBlob(e){return this.log("debug",`Viewing blob: ${e}`),this.blobManager.viewBlob(e)}loadBlobData(e){this.log("debug",`Loading blob data: ${e}`),this.client.getMediaBlobData(e)}getConnectionStatus(){return this.client.getStatus()}isConnected(){return this.client.getStatus()===Oe.Connected}getUserCount(){return 0}getConnectionId(){return""}getBlobs(){return this.blobManager.getBlobs()}getBlobDisplayInfo(e){return this.blobManager.getBlobDisplayInfo(e)}get mediaManager(){return this.blobManager}getUploadStats(){return this.uploadHandler.getStats()}getCacheStats(){return this.blobManager.getCacheStats()}clearCompletedUploads(){this.uploadHandler.clearCompleted()}clearBlobCache(){this.blobManager.clearCache()}getEventLog(){return[...this.eventLog]}clearEventLog(){this.eventLog=[],this.dispatchEvent(new CustomEvent("log-cleared",{detail:{timestamp:Date.now()}}))}setupEventHandlers(){this.client.on("statusChange",e=>{this.log("info",`Connection status changed: ${e}`),this.dispatchEvent(new CustomEvent("status-change",{detail:{status:e}})),e===Oe.Connected&&this.options.autoGetMediaBlobs&&setTimeout(()=>this.getMediaBlobs(),100)}),this.client.on("welcome",e=>{this.log("info","Welcome received",e),this.dispatchEvent(new CustomEvent("welcome",{detail:e}))}),this.client.on("error",e=>{this.log("error","Server error",e),this.dispatchEvent(new CustomEvent("server-error",{detail:e}))}),this.client.on("parseError",(e,t)=>{this.log("error","Parse error",{error:e.message,rawMessage:t}),this.dispatchEvent(new CustomEvent("parse-error",{detail:{error:e.message,rawMessage:t}}))}),this.client.on("mediaBlobs",e=>{this.handleServerMessage({type:"MediaBlobs",data:e})}),this.client.on("mediaBlob",e=>{this.handleServerMessage({type:"MediaBlob",data:e})}),this.client.on("mediaBlobData",e=>{this.handleServerMessage({type:"MediaBlobData",data:e})}),this.client.on("connectionStatus",e=>{this.handleServerMessage({type:"ConnectionStatus",data:e})}),this.blobManager.addEventListener("blobs-updated",e=>{const t=e.detail;this.log("info",`Media blobs updated: ${t.count} blobs`),this.dispatchEvent(new CustomEvent("blobs-updated",{detail:t}))}),this.blobManager.addEventListener("blob-data-requested",e=>{const{id:t}=e.detail;this.client.getMediaBlobData(t)}),this.blobManager.addEventListener("blob-data-cached",e=>{const t=e.detail;this.log("debug",`Blob data cached: ${t.id}`),this.dispatchEvent(new CustomEvent("blob-data-cached",{detail:t}))}),this.uploadHandler.addEventListener("upload-started",e=>{const{file:t}=e.detail;this.log("info",`Upload started: ${t.name}`),this.dispatchEvent(new CustomEvent("upload-started",{detail:e.detail}))}),this.uploadHandler.addEventListener("upload-completed",e=>{const{file:t,blob:r}=e.detail;this.log("info",`Upload completed: ${t.name}`),this.client.uploadMediaBlob(r),this.dispatchEvent(new CustomEvent("upload-completed",{detail:e.detail}))}),this.uploadHandler.addEventListener("upload-error",e=>{const{file:t,error:r}=e.detail;this.log("error",`Upload failed: ${t.name}`,{error:r}),this.dispatchEvent(new CustomEvent("upload-error",{detail:e.detail}))})}handleServerMessage(e){switch(e.type){case"MediaBlobs":{const t=e.data;this.log("info",`Received ${t?.blobs?.length||0} media blobs`),this.blobManager.updateBlobs(t?.blobs||[]);break}case"MediaBlob":{const r=e.data?.blob;this.log("info",`Received single media blob: ${r?.id}`);break}case"MediaBlobData":{const t=e.data;this.log("debug",`Received blob data: ${t?.id}`),t&&this.blobManager.cacheBlobData(t);break}case"Error":{const r=e.data?.message||"Server error";this.log("error",`Server error: ${r}`),this.dispatchEvent(new CustomEvent("server-error",{detail:{error:r}}));break}default:this.log("debug",`Unknown message type: ${e.type}`)}this.dispatchEvent(new CustomEvent("message",{detail:{message:e}}))}log(e,t,r){if(!this.shouldLog(e))return;const s={type:e,timestamp:Date.now(),data:{message:t,data:r}};this.eventLog.push(s),this.eventLog.length>100&&(this.eventLog=this.eventLog.slice(-100)),this.dispatchEvent(new CustomEvent("log",{detail:s}));const a=new Date().toLocaleTimeString(),c=r?`[${a}] [WebSocketDemo] ${t}: ${JSON.stringify(r,null,2)}`:`[${a}] [WebSocketDemo] ${t}`;switch(e){case"error":console.error(c);break;case"warn":console.warn(c);break;case"debug":console.debug(c);break;default:console.log(c)}}shouldLog(e){const t=["none","error","warn","info","debug"],r=t.indexOf(this.options.logLevel||"info");return t.indexOf(e)<=r}destroy(){this.log("info","Destroying WebSocket demo client"),this.client.disconnect(),this.blobManager.destroy(),this.uploadHandler.destroy(),this.eventLog=[],["status-change","welcome","blobs-updated","blob-data-cached","upload-started","upload-completed","upload-error","server-error","parse-error","message","log","log-cleared"].forEach(t=>{(this._listeners?.[t]||[]).forEach(s=>{this.removeEventListener(t,s)})})}}const Mt=le({filename:S().min(1),mime_type:S().optional(),sha256:S().length(64),size:Y().int().positive(),metadata:We(Ne()).default({})}),At=le({id:S().uuid(),local_path:S().nullish(),sha256:S(),size:Y().int().positive(),mime_type:S().optional(),created_at:S().datetime()}),je=le({id:S().uuid(),local_path:S().nullish(),sha256:S(),size:Y().int().optional(),mime:S().optional(),source_client_id:S().optional(),metadata:We(Ne()).default({}),created_at:S().datetime(),updated_at:S().datetime()}),Tt=le({uploads:Et(je),total_count:Y().int().min(0),limit:Y().int().optional(),offset:Y().int().min(0)});class I extends Error{constructor(e,t,r){super(t),this.type=e,this.originalError=r,this.name="UploadError"}}class Rt extends EventTarget{config;activeUploads=new Map;constructor(e={}){super(),this.config={baseUrl:"http://localhost:3000",minFileSize:10*1024*1024,maxFileSize:1024*1024*1024,timeoutMs:5*60*1e3,credentials:!0,...e}}async uploadFile(e,t={}){const r=crypto.randomUUID();try{this.validateFile(e);const s=new AbortController;this.activeUploads.set(r,s),this.emitProgress({uploadId:r,stage:"preparing",progress:0,totalBytes:e.size}),this.emitProgress({uploadId:r,stage:"hashing",progress:10,totalBytes:e.size});const a=await this.calculateSHA256(e);this.emitProgress({uploadId:r,stage:"hashing",progress:50,totalBytes:e.size});const c={filename:e.name,mime_type:e.type||void 0,sha256:a,size:e.size,metadata:t};Mt.parse(c),this.emitProgress({uploadId:r,stage:"uploading",progress:60,totalBytes:e.size});const p=new FormData;p.append("metadata",JSON.stringify(c)),p.append("file",e);const _=await fetch(`${this.config.baseUrl}/api/upload`,{method:"POST",body:p,credentials:this.config.credentials?"include":"omit",signal:s.signal});if(this.emitProgress({uploadId:r,stage:"uploading",progress:90,bytesUploaded:e.size,totalBytes:e.size}),!_.ok)throw await this.handleErrorResponse(_);const re=await _.json(),se=At.parse(re);return this.emitProgress({uploadId:r,stage:"completed",progress:100,bytesUploaded:e.size,totalBytes:e.size}),se}catch(s){const a=s instanceof I?s:new I("SERVER_ERROR",s instanceof Error?s.message:String(s),s instanceof Error?s:void 0);throw this.emitProgress({uploadId:r,stage:"error",progress:0,error:a}),a}finally{this.activeUploads.delete(r)}}async getUploadInfo(e){const t=await fetch(`${this.config.baseUrl}/api/upload/${e}`,{method:"GET",credentials:this.config.credentials?"include":"omit"});if(!t.ok)throw await this.handleErrorResponse(t);const r=await t.json();return je.parse(r)}async listUploads(e={}){const t=new URLSearchParams;e.limit!==void 0&&t.set("limit",e.limit.toString()),e.offset!==void 0&&t.set("offset",e.offset.toString());const r=`${this.config.baseUrl}/api/uploads${t.toString()?`?${t}`:""}`,s=await fetch(r,{method:"GET",credentials:this.config.credentials?"include":"omit"});if(!s.ok)throw await this.handleErrorResponse(s);const a=await s.json();return Tt.parse(a)}async deleteUpload(e){const t=await fetch(`${this.config.baseUrl}/api/upload/${e}`,{method:"DELETE",credentials:this.config.credentials?"include":"omit"});if(!t.ok)throw await this.handleErrorResponse(t)}cancelUpload(e){const t=this.activeUploads.get(e);return t?(t.abort(),this.activeUploads.delete(e),!0):!1}cancelAllUploads(){for(const e of this.activeUploads.values())e.abort();this.activeUploads.clear()}getActiveUploadCount(){return this.activeUploads.size}updateConfig(e){this.config={...this.config,...e}}validateFile(e){if(e.size<this.config.minFileSize)throw new I("FILE_TOO_SMALL",`File size ${this.formatFileSize(e.size)} is below the minimum of ${this.formatFileSize(this.config.minFileSize)}`);if(e.size>this.config.maxFileSize)throw new I("FILE_TOO_LARGE",`File size ${this.formatFileSize(e.size)} exceeds the maximum of ${this.formatFileSize(this.config.maxFileSize)}`);if(e.size===0)throw new I("INVALID_FILE","File is empty");if(e.name.includes("..")||e.name.includes("/")||e.name.includes("\\"))throw new I("INVALID_FILE","Invalid filename")}async calculateSHA256(e){try{const t=await e.arrayBuffer(),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(a=>a.toString(16).padStart(2,"0")).join("")}catch(t){throw new I("HASH_CALCULATION_FAILED","Failed to calculate file hash",t instanceof Error?t:void 0)}}async handleErrorResponse(e){let t,r;try{const s=await e.json();t=s.error||s.message||`HTTP ${e.status}`}catch{t=`HTTP ${e.status} ${e.statusText}`}switch(e.status){case 400:r="INVALID_FILE";break;case 401:r="UNAUTHORIZED";break;case 403:r="FORBIDDEN";break;case 409:r="CONFLICT";break;case 413:r="FILE_TOO_LARGE";break;default:r=e.status>=500?"SERVER_ERROR":"NETWORK_ERROR"}return new I(r,t)}emitProgress(e){this.dispatchEvent(new CustomEvent("upload-progress",{detail:e}))}formatFileSize(e){if(!e)return"0 B";const t=["B","KB","MB","GB"];let r=e,s=0;for(;r>=1024&&s<t.length-1;)r/=1024,s++;return`${r.toFixed(1)} ${t[s]}`}static shouldUseHttpUpload(e,t=10*1024*1024){return e.size>=t}static formatFileSize(e){if(!e)return"0 B";const t=["B","KB","MB","GB"];let r=e,s=0;for(;r>=1024&&s<t.length-1;)r/=1024,s++;return`${r.toFixed(1)} ${t[s]}`}}var Ht=m("<div>⚠️ Large file uploads (≥10MB) require admin privileges"),It=m("<div><h3>Upload Progress (<!> active)</h3><button>Clear Progress"),Ot=m("<div class=blob-list>"),Wt=m("<div>No log entries yet..."),Nt=m("<div class=demo-section><h2 class=section-title>Debug Log</h2><div class=controls><button>Clear Log</button></div><div class=log-container>"),jt=m(`<div><style>
        .demo-section { margin-bottom: 2rem; }
        .controls { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
        button {
          padding: 0.5rem 1rem;
          border: 1px solid #ccc;
          background: white;
          cursor: pointer;
          border-radius: 4px;
          font-size: 0.875rem;
          font-weight: 500;
        }
        button:hover:not(:disabled) { background: #f0f0f0; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
        button.primary:hover:not(:disabled) { background: #2563eb; }
        input[type="text"] {
          padding: 0.5rem;
          border: 1px solid #ccc;
          border-radius: 4px;
          min-width: 300px;
          font-size: 0.875rem;
        }
        .status-indicator {
          display: inline-block;
          width: 12px;
          height: 12px;
          border-radius: 50%;
          margin-right: 0.5rem;
        }
        .log-container {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 4px;
          padding: 1rem;
          max-height: 300px;
          overflow-y: auto;
          font-family: monospace;
          font-size: 0.875rem;
          white-space: pre-wrap;
        }
        .blob-list { display: grid; gap: 1rem; }
        .blob-item {
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 1rem;
          background: white;
        }
        .blob-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 0.5rem;
        }
        .blob-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .blob-actions button {
          font-size: 0.75rem;
          padding: 0.25rem 0.5rem;
          font-weight: normal;
        }
        .blob-actions a {
          color: #3b82f6;
          text-decoration: none;
          font-size: 0.75rem;
        }
        .blob-actions a:hover {
          text-decoration: underline;
        }
        .section-title {
          margin: 0 0 1rem 0;
          color: #374151;
          font-weight: 600;
        }
        .empty-state {
          text-align: center;
          padding: 2rem;
          color: #6b7280;
          font-style: italic;
        }
        .smart-upload-zone {
          border: 2px dashed #d1d5db;
          border-radius: 8px;
          padding: 2rem;
          text-align: center;
          margin: 1rem 0;
          background: #fafafa;
          transition: all 0.2s ease;
          cursor: pointer;
        }
        .smart-upload-zone:hover {
          border-color: #3b82f6;
          background: #eff6ff;
        }
        .smart-upload-zone.disabled {
          opacity: 0.5;
          cursor: not-allowed;
          pointer-events: none;
        }
        .upload-status {
          background: #f3f4f6;
          border-radius: 6px;
          padding: 0.75rem;
          margin: 0.5rem 0;
          font-size: 0.875rem;
        }
        .upload-status.success {
          background: #d1fae5;
          color: #065f46;
        }
        .upload-status.error {
          background: #fee2e2;
          color: #991b1b;
        }
        .user-role {
          display: inline-block;
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          font-size: 0.75rem;
          font-weight: 500;
          margin-left: 0.5rem;
        }
        .user-role.admin {
          background: #d1fae5;
          color: #065f46;
        }
        .user-role.member {
          background: #dbeafe;
          color: #1e40af;
        }
      </style><h1>WebSocket Demo (Modular Components)</h1><div class=demo-section><h2 class=section-title>Connection</h2><div class=controls><input type=text placeholder="WebSocket URL"><button class=primary>Connect</button><button>Disconnect</button></div><div><span class=status-indicator></span>Status: <span></span></div></div><div class=demo-section><h2 class=section-title>Smart File Upload</h2><p>Drag & drop files or click to select. Files are automatically routed:<br>• &lt;10MB: WebSocket → Database (any user)<br>• ≥10MB: HTTP API → Disk (admin only)</p><div><div>📁</div><div>Drop files here or click to upload</div><div>Smart routing: Small files via WebSocket, large files via HTTP</div></div><input type=file multiple><div class=controls><button>Ping</button><button>Refresh Media Blobs</button><button>Clear Log</button></div></div><div class=demo-section><h2 class=section-title>Upload Capabilities</h2><div><div><div>💾 Small Files (&lt;10MB)</div><div>• Method: WebSocket<br>• Storage: Database (BYTEA)<br>• Access: Any authenticated user<br>• Status: </div></div><div><div>🗄️ Large Files (≥10MB)</div><div>• Method: HTTP API<br>• Storage: Disk files<br>• Access: Admin users only<br>• Status: </div></div></div></div><div class=demo-section><h2 class=section-title>Media Library (<!> files)<span> disk, <!> database`),qt=m("<div>: <!>%"),Vt=m("<span> (<!> / <!>)"),Gt=m("<div class=empty-state>No media blobs yet. Upload a file or get blobs from server."),Kt=m("<button>🚀 Open File"),Jt=m("<button>👁️ Preview"),Yt=m("<button>📊 Load Data"),Qt=m("<div class=blob-item><div class=blob-header><div><strong></strong><br><small> • </small><br><small></small></div><div></div></div><div><small><br>Created: <br>Source: </small></div><div class=blob-actions><button>📥 Download"),Zt=m('<span title="This video format may not play in all browsers (Chrome/Firefox). Works best in Safari.">⚠️ Limited browser support'),Xt=m("<span>✅ Web compatible"),er=m("<span>🗄️ Disk (Large file)"),tr=m("<span>💾 Database (Small file)"),rr=m("<br>"),sr=m("<a target=_blank rel=noopener>🔗 Direct file access"),or=m("<div>");const ir=D=>{const[e,t]=P(null),[r,s]=P("disconnected"),[a,c]=P(0),[p,_]=P([]),[re,se]=P([]),[qe,Ve]=P(0),[we,Se]=P("ws://localhost:8080/ws"),[_e]=P("http://localhost:8080"),[z,xe]=P(!1),[de,ce]=P(new Map),[Ge,Ke]=P(null);Ie(()=>{const l=D.websocketUrl;l&&Se(l)});let ue;window.loadBlobData=l=>{e()?.loadBlobData(l)},Ie(()=>{const l=we(),g=new Ft(l,{logLevel:"info",autoGetMediaBlobs:!0}),v=new Rt({baseUrl:_e(),minFileSize:10*1024*1024,maxFileSize:1024*1024*1024});v.addEventListener("upload-progress",d=>{const x=d.detail;ce(B=>{const w=new Map(B);return w.set(x.uploadId,x),w})}),Ke(v),g.addEventListener("status-change",d=>{const{status:x,userCount:B}=d.detail;s(x),c(B||0)}),g.addEventListener("blobs-updated",d=>{const x=d.detail.blobs;_(x),g.mediaManager?.updateBaseUrl(_e())}),g.addEventListener("blob-data-cached",()=>{Ve(d=>d+1)}),g.addEventListener("log",d=>{const{message:x,data:B}=d.detail.data,w=B?`${x}: ${JSON.stringify(B)}`:x;se(O=>[...O.slice(-49),w])}),t(g),fetch("/api/whoami",{credentials:"include"}).then(d=>d.json()).then(d=>{xe(d.role==="admin")}).catch(()=>{xe(!1)}),D.autoConnect&&g.connect().catch(console.error),kt(()=>{g.destroy(),v.cancelAllUploads()})});const Je=()=>{e()?.connect().catch(console.error)},Ye=()=>{e()?.disconnect()},Qe=()=>{e()?.ping()},Ee=()=>{e()?.getMediaBlobs()},Ze=l=>{const g=l.target,v=g.files;v&&v.length>0&&(Ce(Array.from(v)),g.value="")},Xe=()=>{ue?.click()},Ce=async l=>{const g=e(),v=Ge();if(!g||r()!=="connected"){console.error("WebSocket not connected");return}for(const d of l){const x=d.size;if(x>=10*1024*1024){if(!z()){console.error(`File "${d.name}" is ${pe(x)} which requires admin access`);continue}if(!v){console.error("HTTP uploader not available");continue}try{const w=await v.uploadFile(d,{uploadedVia:"websocket-demo",originalMethod:"http"});console.log(`Large file uploaded successfully: ${d.name}`,w),Ee(),setTimeout(()=>{ce(O=>{const q=new Map(O);for(const[V,Q]of q.entries())Q.stage==="completed"&&q.delete(V);return q})},3e3)}catch(w){console.error(`Failed to upload large file "${d.name}":`,w)}}else try{await g.uploadFiles([d]),console.log(`Small file uploaded successfully: ${d.name}`)}catch(w){console.error(`Failed to upload small file "${d.name}":`,w)}}},et=l=>{l.preventDefault(),l.dataTransfer?.files&&Ce(Array.from(l.dataTransfer.files))},tt=l=>{l.preventDefault()},pe=l=>{if(!l)return"0 B";const g=["B","KB","MB","GB"];let v=l,d=0;for(;v>=1024&&d<g.length-1;)v/=1024,d++;return`${v.toFixed(1)} ${g[d]}`},rt=(l,g)=>{e()?.downloadBlob(l,g)},st=l=>{e()?.viewBlob(l)},ot=l=>{e()?.loadBlobData(l)},Pe=()=>{se([]),e()?.clearEventLog()},it=()=>{switch(r()){case"connected":return"#10b981";case"connecting":return"#f59e0b";case"error":return"#ef4444";default:return"#6b7280"}};return(()=>{var l=jt(),g=l.firstChild,v=g.nextSibling,d=v.nextSibling,x=d.firstChild,B=x.nextSibling,w=B.firstChild,O=w.nextSibling,q=O.nextSibling,V=B.nextSibling,Q=V.firstChild,at=Q.nextSibling,oe=at.nextSibling,he=d.nextSibling,nt=he.firstChild,ie=nt.nextSibling,W=ie.nextSibling,ge=W.firstChild,me=ge.nextSibling,ke=me.nextSibling,G=W.nextSibling,Be=G.nextSibling,be=Be.firstChild,fe=be.nextSibling,lt=fe.nextSibling,Ue=he.nextSibling,dt=Ue.firstChild,Z=dt.nextSibling,K=Z.firstChild,ae=K.firstChild,ne=ae.nextSibling,ct=ne.firstChild,ut=ct.nextSibling,pt=ut.nextSibling,ht=pt.nextSibling,gt=ht.nextSibling,mt=gt.nextSibling;mt.nextSibling;var N=K.nextSibling,X=N.firstChild,ee=X.nextSibling,bt=ee.firstChild,ft=bt.nextSibling,yt=ft.nextSibling,vt=yt.nextSibling,$t=vt.nextSibling,wt=$t.nextSibling;wt.nextSibling;var Le=Ue.nextSibling,ze=Le.firstChild,St=ze.firstChild,De=St.nextSibling,_t=De.nextSibling,j=_t.nextSibling,Fe=j.firstChild,Me=Fe.nextSibling;Me.nextSibling,l.style.setProperty("padding","1rem"),l.style.setProperty("font-family","sans-serif"),w.$$input=o=>Se(o.target.value),O.$$click=Je,q.$$click=Ye,V.style.setProperty("margin-bottom","1rem"),n(V,r,oe),n(V,k(H,{get when(){return a()>0},get children(){return[" ","(",R(()=>a())," user",R(()=>a()!==1?"s":"")," online)"]}}),oe),n(oe,()=>z()?"Admin":"Member"),ie.style.setProperty("color","#6b7280"),ie.style.setProperty("margin-bottom","1rem"),ie.style.setProperty("font-size","0.875rem"),W.addEventListener("dragover",tt),W.addEventListener("drop",et),W.$$click=Xe,ge.style.setProperty("font-size","2rem"),ge.style.setProperty("margin-bottom","0.5rem"),me.style.setProperty("font-weight","500"),me.style.setProperty("margin-bottom","0.5rem"),ke.style.setProperty("font-size","0.875rem"),ke.style.setProperty("color","#6b7280"),n(W,k(H,{get when(){return!z()},get children(){var o=Ht();return o.style.setProperty("font-size","0.75rem"),o.style.setProperty("color","#dc2626"),o.style.setProperty("margin-top","0.5rem"),o}}),null),G.addEventListener("change",Ze);var Ae=ue;return typeof Ae=="function"?Ut(Ae,G):ue=G,G.style.setProperty("display","none"),Be.style.setProperty("margin-top","1rem"),be.$$click=Qe,fe.$$click=Ee,lt.$$click=Pe,n(he,k(H,{get when(){return de().size>0},get children(){var o=It(),h=o.firstChild,$=h.firstChild,U=$.nextSibling;U.nextSibling;var b=h.nextSibling;return o.style.setProperty("margin-top","1rem"),h.style.setProperty("margin-bottom","0.5rem"),h.style.setProperty("font-size","1rem"),n(h,()=>de().size,U),n(o,k(ve,{get each(){return Array.from(de().values())},children:u=>(()=>{var f=qt(),L=f.firstChild,E=L.nextSibling;return E.nextSibling,n(f,()=>u.stage==="completed"&&"✅ ",L),n(f,()=>u.stage==="error"&&"❌ ",L),n(f,()=>u.stage==="uploading"&&"📤 ",L),n(f,()=>u.stage,L),n(f,()=>u.progress,E),n(f,(()=>{var J=R(()=>!!(u.bytesUploaded&&u.totalBytes));return()=>J()&&(()=>{var C=Vt(),F=C.firstChild,M=F.nextSibling,A=M.nextSibling,T=A.nextSibling;return T.nextSibling,C.style.setProperty("color","#6b7280"),n(C,()=>pe(u.bytesUploaded),M),n(C,()=>pe(u.totalBytes),T),C})()})(),null),n(f,()=>u.error&&` - ${u.error.message}`,null),te(()=>$e(f,`upload-status ${u.stage==="completed"?"success":u.stage==="error"?"error":""}`)),f})()}),b),b.$$click=()=>ce(new Map),b.style.setProperty("margin-top","0.5rem"),b.style.setProperty("padding","0.25rem 0.5rem"),b.style.setProperty("font-size","0.75rem"),b.style.setProperty("background","#f3f4f6"),b.style.setProperty("border","1px solid #d1d5db"),b.style.setProperty("border-radius","4px"),b.style.setProperty("cursor","pointer"),o}}),null),Z.style.setProperty("display","grid"),Z.style.setProperty("grid-template-columns","1fr 1fr"),Z.style.setProperty("gap","1rem"),Z.style.setProperty("margin-bottom","1rem"),K.style.setProperty("background","#dbeafe"),K.style.setProperty("padding","1rem"),K.style.setProperty("border-radius","6px"),K.style.setProperty("border","1px solid #93c5fd"),ae.style.setProperty("font-weight","500"),ae.style.setProperty("color","#1e40af"),ae.style.setProperty("margin-bottom","0.5rem"),ne.style.setProperty("font-size","0.875rem"),ne.style.setProperty("color","#1e40af"),n(ne,()=>r()==="connected"?"✅ Available":"❌ Requires connection",null),N.style.setProperty("padding","1rem"),N.style.setProperty("border-radius","6px"),X.style.setProperty("font-weight","500"),X.style.setProperty("margin-bottom","0.5rem"),ee.style.setProperty("font-size","0.875rem"),n(ee,()=>z()?"✅ Available":"❌ Admin required",null),n(ze,()=>p().length,De),j.style.setProperty("font-size","0.875rem"),j.style.setProperty("font-weight","normal"),j.style.setProperty("color","#6b7280"),j.style.setProperty("margin-left","0.5rem"),n(j,()=>p().filter(o=>o.local_path).length,Fe),n(j,()=>p().filter(o=>!o.local_path).length,Me),n(Le,k(H,{get when(){return p().length>0},get fallback(){return Gt()},get children(){var o=Ot();return n(o,k(ve,{get each(){return p()},children:h=>{const $=()=>(qe(),e()?.getBlobDisplayInfo(h));return(()=>{var U=Qt(),b=U.firstChild,u=b.firstChild,f=u.firstChild,L=f.nextSibling,E=L.nextSibling,J=E.firstChild,C=E.nextSibling,F=C.nextSibling,M=u.nextSibling,A=b.nextSibling,T=A.firstChild,Te=T.firstChild,xt=Te.nextSibling,Re=xt.nextSibling;Re.nextSibling;var ye=A.nextSibling,He=ye.firstChild;return n(f,()=>h.id),n(E,()=>$()?.mime,J),n(E,()=>$()?.size,null),n(E,(()=>{var y=R(()=>!!(h.mime==="video/quicktime"||h.local_path?.toLowerCase().endsWith(".mov")));return()=>y()?(()=>{var i=Zt();return i.style.setProperty("background","#fef3c7"),i.style.setProperty("color","#92400e"),i.style.setProperty("padding","0.125rem 0.5rem"),i.style.setProperty("border-radius","4px"),i.style.setProperty("font-size","0.7rem"),i.style.setProperty("font-weight","500"),i.style.setProperty("margin-left","0.5rem"),i})():R(()=>!!h.mime?.startsWith("video/"))()?(()=>{var i=Xt();return i.style.setProperty("background","#d1fae5"),i.style.setProperty("color","#065f46"),i.style.setProperty("padding","0.125rem 0.5rem"),i.style.setProperty("border-radius","4px"),i.style.setProperty("font-size","0.7rem"),i.style.setProperty("font-weight","500"),i.style.setProperty("margin-left","0.5rem"),i})():null})(),null),F.style.setProperty("color","#6b7280"),n(F,(()=>{var y=R(()=>$()?.storageType==="disk");return()=>y()?(()=>{var i=er();return i.style.setProperty("background","#d1fae5"),i.style.setProperty("color","#065f46"),i.style.setProperty("padding","0.125rem 0.5rem"),i.style.setProperty("border-radius","4px"),i.style.setProperty("font-size","0.75rem"),i.style.setProperty("font-weight","500"),i})():(()=>{var i=tr();return i.style.setProperty("background","#dbeafe"),i.style.setProperty("color","#1e40af"),i.style.setProperty("padding","0.125rem 0.5rem"),i.style.setProperty("border-radius","4px"),i.style.setProperty("font-size","0.75rem"),i.style.setProperty("font-weight","500"),i})()})()),T.style.setProperty("color","#6b7280"),n(T,(()=>{var y=R(()=>!!h.local_path);return()=>y()?["Path: ",R(()=>h.local_path),rr(),(()=>{var i=sr();return i.style.setProperty("color","#3b82f6"),i.style.setProperty("text-decoration","none"),te(()=>Bt(i,"href",$()?.fileUrl)),i})()]:"Stored in database"})(),Te),n(T,()=>new Date(h.created_at).toLocaleString(),Re),n(T,()=>h.source_client_id||"Unknown",null),n(ye,k(H,{get when(){return $()?.storageType==="disk"},get children(){var y=Kt();return y.$$click=()=>window.open($()?.fileUrl,"_blank"),y.style.setProperty("background","#10b981"),y.style.setProperty("color","white"),y.style.setProperty("border","none"),y}}),He),He.$$click=()=>rt(h.id,h.local_path),n(ye,k(H,{get when(){return $()?.storageType==="database"},get children(){return[(()=>{var y=Jt();return y.$$click=()=>st(h.id),y})(),(()=>{var y=Yt();return y.$$click=()=>ot(h.id),y})()]}}),null),te(()=>M.innerHTML=$()?.thumbnailHtml),U})()}})),o}}),null),n(l,k(H,{get when(){return D.showDebugLog},get children(){var o=Nt(),h=o.firstChild,$=h.nextSibling,U=$.firstChild,b=$.nextSibling;return U.$$click=Pe,n(b,k(ve,{get each(){return re()},children:u=>(()=>{var f=or();return n(f,u),f})()}),null),n(b,k(H,{get when(){return re().length===0},get children(){var u=Wt();return u.style.setProperty("color","#6b7280"),u.style.setProperty("font-style","italic"),u}}),null),o}}),null),te(o=>{var h=r()==="connected"||r()==="connecting",$=r()==="connected"||r()==="connecting",U=r()==="disconnected",b=it(),u=`user-role ${z()?"admin":"member"}`,f=`smart-upload-zone ${r()!=="connected"?"disabled":""}`,L=r()!=="connected",E=r()!=="connected",J=r()!=="connected",C=z()?"#d1fae5":"#fee2e2",F=z()?"1px solid #86efac":"1px solid #fca5a5",M=z()?"#065f46":"#991b1b",A=z()?"#065f46":"#991b1b";return h!==o.e&&(w.disabled=o.e=h),$!==o.t&&(O.disabled=o.t=$),U!==o.a&&(q.disabled=o.a=U),b!==o.o&&((o.o=b)!=null?Q.style.setProperty("background-color",b):Q.style.removeProperty("background-color")),u!==o.i&&$e(oe,o.i=u),f!==o.n&&$e(W,o.n=f),L!==o.s&&(G.disabled=o.s=L),E!==o.h&&(be.disabled=o.h=E),J!==o.r&&(fe.disabled=o.r=J),C!==o.d&&((o.d=C)!=null?N.style.setProperty("background",C):N.style.removeProperty("background")),F!==o.l&&((o.l=F)!=null?N.style.setProperty("border",F):N.style.removeProperty("border")),M!==o.u&&((o.u=M)!=null?X.style.setProperty("color",M):X.style.removeProperty("color")),A!==o.c&&((o.c=A)!=null?ee.style.setProperty("color",A):ee.style.removeProperty("color")),o},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0}),te(()=>w.value=we()),l})()};Ct("websocket-demo",{websocketUrl:"ws://localhost:8080/ws",autoConnect:!1,showDebugLog:!0},ir);Pt(["input","click"]);export{Rt as F,Dt as W};
//# sourceMappingURL=websocket-demo.js.map

  </script>
</body>
</html>